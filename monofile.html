<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ensemble — MVP</title>
  <style>
    :root {
      --bg: #0b0b0b; --accent: #eaeaea; --muted: #bdbdbd;
      --disk: #3a3a3a; --label: #1a1a1a; --white: #ffffff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg); color: var(--accent);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      min-height: 100vh; display: grid; place-items: start center; padding-top: 32px;
    }
    #root { width: 100%; max-width: 860px; padding: 0 20px 60px; }

    /* Landing */
    .wrap { text-align: center; }
    .stage { width: 360px; height: 360px; margin: -400px auto 400px; position: relative; display: grid; place-items: center; transform: scale(2); transform-origin: center top; }
    .disk {
      width: 340px; height: 340px; border-radius: 50%;
      background: radial-gradient(circle at 50% 50%, #4a4a4a 0%, #3e3e3e 35%, #2f2f2f 70%, #262626 100%);
      box-shadow: inset 0 0 0 6px rgba(255,255,255,0.03), inset 0 0 0 1px rgba(0,0,0,0.5), 0 12px 40px rgba(0,0,0,0.35);
      animation: spin 6s linear infinite; position: relative;
    }
    .disk::after {
      content: ""; position: absolute; inset: 12px; border-radius: 50%;
      background: repeating-radial-gradient(circle at 50% 50%, rgba(255,255,255,0.05) 0 1px, rgba(0,0,0,0.05) 1px 2px);
      mix-blend-mode: overlay; opacity: 0.35; pointer-events: none;
    }
    .label { position: absolute; width: 104px; height: 104px; border-radius: 50%; background: radial-gradient(circle, #2c2c2c, var(--label)); inset: 0; margin: auto; box-shadow: inset 0 0 14px rgba(0,0,0,0.5); }
    .spindle { position: absolute; width: 10px; height: 10px; border-radius: 50%; background: #111; inset: 0; margin: auto; box-shadow: 0 0 0 3px rgba(0,0,0,0.35); }
    .text-ring { position: absolute; width: 360px; height: 360px; top: 0; left: 0; animation: spin 8s linear infinite reverse; pointer-events: none; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .cta {
      appearance: none; background: #ffffff; color: #0b0b0b; border: 0; border-radius: 999px;
      padding: 24px 36px; font-weight: 600; font-size: 15px; cursor: pointer;
      box-shadow: 0 8px 20px rgba(255,255,255,0.08);
      transition: transform 120ms ease, box-shadow 120ms ease, opacity 120ms ease;
    }
    .cta:hover { transform: translateY(-1px); box-shadow: 0 10px 26px rgba(255,255,255,0.12); }
    .cta:active { transform: translateY(0); box-shadow: 0 6px 16px rgba(255,255,255,0.08); }
    .muted { color: var(--muted); font-size: 13px; margin-top: 14px; text-align: center; }

    .sr-only {
      position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden;
      clip: rect(0, 0, 1px, 1px); white-space: nowrap; border: 0;
    }

    /* Editor screen */
    .editor {
      display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
      background: #111; border: 1px solid #222; border-radius: 16px; padding: 18px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
    }
    .editor .panel {
      background: #161616; border: 1px solid #232323; border-radius: 12px; padding: 16px;
    }
    .row { display: grid; grid-template-columns: 140px 1fr 60px; gap: 12px; align-items: center; margin-bottom: 12px; }
    .row label { color: var(--accent); font-size: 14px; }
    .row input[type="range"] { width: 100%; }
    .row output { color: var(--muted); font-size: 13px; text-align: right; }

    .toolbar { display: flex; gap: 10px; align-items: center; margin-bottom: 14px; justify-content: space-between; }
    .btn {
      appearance: none; background: #fff; color: #0b0b0b; font-weight: 600;
      padding: 20px 28px; border-radius: 10px; border: none; cursor: pointer;
    }
    .btn.secondary { background: #2a2a2a; color: #eaeaea; border: 1px solid #3a3a3a; }
    .filename { font-size: 14px; color: var(--muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 60%; }

    audio { width: 100%; margin-top: 8px; }
    @media (max-width: 860px) {
      .editor { grid-template-columns: 1fr; }
      .filename { max-width: 100%; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React via ESM, no JSX so it runs inline -->
  <script type="module">
    import React, { useRef, useState } from 'https://esm.sh/react@18';
    import { createRoot } from 'https://esm.sh/react-dom@18/client';
    const h = React.createElement;

    const API = "";

    function debounce(fn, ms=400) {
      let t;
      return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
    }

    function Vinyl() {
      const text = (" ensemble •").repeat(28) + " ";
      return h(
        'div', { className: 'stage', 'aria-hidden': 'true' },
        h('div', { className: 'disk' },
          h('div', { className: 'label' }),
          h('div', { className: 'spindle' })
        ),
        h('svg', { className: 'text-ring', viewBox: '0 0 360 360' },
          h('defs', null,
            h('path', { id: 'circlePath', d: 'M 180,180 m -145,0 a 145,145 0 1,1 290,0 a 145,145 0 1,1 -290,0' })
          ),
          h('g', null,
            h('text', { fill: 'white', fontSize: '18', fontWeight: '600', letterSpacing: '2', style: { textTransform: 'uppercase' } },
              h('textPath', { href: '#circlePath', startOffset: '0%' }, text)
            )
          )
        )
      );
    }

    function Landing({ onPick }) {
      const inputRef = useRef(null);
      const openPicker = () => inputRef.current?.click();

      // UPDATED: upload file, then provide metadata to onPick
      async function onChange(e) {
        const f = e.target.files?.[0];
        if (!f) return;

        const fd = new FormData();
        fd.append("file", f);

        const res = await fetch(`${API}/upload`, { method: "POST", body: fd });
        if (!res.ok) {
          console.error("Upload failed");
          return;
        }
        const json = await res.json();
        onPick({ file: f, fileId: json.file_id, filename: json.filename });
      }

      return h('div', { className: 'wrap' },
        h(Vinyl),
        h('input', {
          ref: inputRef, type: 'file', accept: 'audio/*', className: 'sr-only',
          onChange
        }),
        h('button', { className: 'cta', onClick: openPicker }, 'Choose an audio file'),
        h('div', { className: 'muted' }, 'create a classic')
  );
}


    function Slider({ label, min=0, max=100, step=1, value, onChange }) {
      return h('div', { className: 'row' },
        h('label', null, label),
        h('input', {
          type: 'range', min, max, step, value,
          onChange: (e) => onChange(Number(e.target.value))
        }),
        h('output', null, value)
      );
    }

    function SliderFloat({ label, min=0, max=100, step=0.05, value, onChange }) {
      return h('div', { className: 'row' },
        h('label', null, label),
        h('input', {
          type: 'range', min, max, step, value,
          onChange: (e) => onChange(Number(e.target.value))
        }),
        h('output', null, value)
      );
    }

    function Editor({ meta, onBack }) {
  const { file, fileId, filename } = meta;

  const [vinylWarp, setvinylWarp] = useState(40);
  const [surfaceDamage, setsurfaceDamage] = useState(55);
  const [Dropout, setDropout] = useState(35);
  const [EQ, setEQ] = useState(10);
  const [Resonance, setResonance] = useState(0.2);

  const audioRef = useRef(null);
  const [rawUrl] = useState(() => URL.createObjectURL(file)); // original preview
  const [procUrl, setProcUrl] = useState(null);               // processed preview
  const [busy, setBusy] = useState(false);
  const [lastBlob, setLastBlob] = useState(null);
  const [version, setVersion] = useState(0);
  const versionRef = useRef(version);
  React.useEffect(() => { versionRef.current = version; }, [version]);

  const requestProcess = useRef(
    debounce(async (ver) => {
      setBusy(true);
      const fd = new FormData();
      fd.append("file_id", fileId);
      fd.append("filename", filename);
      fd.append("vinyl_warp", String(vinylWarp));
      fd.append("surface_damage", String(surfaceDamage));
      fd.append("dropout", String(Dropout));
      fd.append("eq", String(EQ));                 // positive = more high-cut
      fd.append("resonance", String(Resonance));   // 0..1
      fd.append("preview_ms", String(15000));      // 15s preview for responsiveness

      const res = await fetch(`${API}/process`, { method: "POST", body: fd });
      if (!res.ok) { setBusy(false); return; }
      const blob = await res.blob();

      if (ver !== versionRef.current) return; // drop stale responses

      const a = audioRef.current;
      const wasPlaying = a && !a.paused;
      const t = a ? a.currentTime : 0;

      if (procUrl) URL.revokeObjectURL(procUrl);
      const url = URL.createObjectURL(blob);
      setProcUrl(url);
      setLastBlob(blob);
      setBusy(false);

      if (a) {
        a.src = url;
        a.currentTime = Math.min(t, a.duration || t);
        if (wasPlaying) a.play().catch(() => {});
      }
    }, 400)
  ).current;

  React.useEffect(() => {
    const v = version + 1;
    setVersion(v);
    requestProcess(v);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [vinylWarp, surfaceDamage, Dropout, EQ, Resonance]);

  const applyPreset = (p) => {
    if (p === 'light') { setvinylWarp(20); setsurfaceDamage(30); setDropout(25); setEQ(5); setResonance(0.1); }
    if (p === 'heavy') { setvinylWarp(70); setsurfaceDamage(80); setDropout(60); setEQ(18); setResonance(0.4); }
  };

  async function downloadProcessed() {
    // Use last preview if available
    if (lastBlob) {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(lastBlob);
      a.download = (filename.replace(/\.[^/.]+$/, "") || "track") + "_processed.wav";
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(() => URL.revokeObjectURL(a.href), 1000);
      return;
    }
    // Or ask backend for full render
    const fd = new FormData();
    fd.append("file_id", fileId);
    fd.append("filename", filename);
    fd.append("vinyl_warp", String(vinylWarp));
    fd.append("surface_damage", String(surfaceDamage));
    fd.append("dropout", String(Dropout));
    fd.append("eq", String(EQ));
    fd.append("resonance", String(Resonance));
    const res = await fetch(`${API}/export`, { method: "POST", body: fd });
    const blob = await res.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = (filename.replace(/\.[^/.]+$/, "") || "track") + "_processed.wav";
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 1000);
  }

  return h('div', null,
    h('div', { className: 'toolbar' },
      h('div', { className: 'filename', title: filename }, `Selected: ${filename}`),
      h('div', { style: { display: 'flex', gap: '10px' } },
        h('button', { className: 'btn secondary', onClick: () => applyPreset('light') }, 'Light preset'),
        h('button', { className: 'btn secondary', onClick: () => applyPreset('heavy') }, 'Heavy preset'),
        h('button', { className: 'btn', onClick: onBack }, 'Back')
      )
    ),
    h('div', { className: 'editor' },
      h('div', { className: 'panel' },
        h('h3', null, 'Vinyl Creation'),
        h(Slider, { label: 'Vinyl Warp', value: vinylWarp, onChange: setvinylWarp }),
        h(Slider, { label: 'Surface Damage', value: surfaceDamage, onChange: setsurfaceDamage }),
        h(Slider, { label: 'Dropout Intensity', value: Dropout, onChange: setDropout })
      ),
      h('div', { className: 'panel' },
        h('h3', null, 'EQ / Resonance'),
        h(Slider, { label: 'EQ Attenuation', value: EQ, onChange: setEQ, max: 24 }),
        h(SliderFloat, { label: 'Stylus Resonance', value: Resonance, onChange: setResonance, max: 1, step: 0.01 }),
        h('div', { style: { marginTop: '14px' } },
          h('audio', { ref: audioRef, src: procUrl || rawUrl, controls: true })
        ),
        h('div', { style: { display: 'flex', gap: '10px', marginTop: '10px' } },
          h('button', { className: 'btn', onClick: downloadProcessed, disabled: busy }, busy ? 'Processing…' : 'Download')
        )
      )
    )
  );
}


    function App() {
      const [meta, setMeta] = useState(null); // { file, fileId, filename }
      return meta
        ? h(Editor, { meta, onBack: () => setMeta(null) })
        : h(Landing, { onPick: setMeta });
    }


    createRoot(document.getElementById('root')).render(h(App));
  </script>
</body>
</html>